#!/bin/bash
# SCRIPT: start
# DESCRIPTION: Start the Nomisma coin analysis application with all required services
# USAGE: ./start [-b] [-s] [-h]
# PARAMETERS:
#   -b    Rebuild Docker images before starting
#   -s    Setup admin user (prompts for username/password)
#   -h    Display this help message
# EXAMPLE: ./start -b -s

# Source script-helpers
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Check if script-helpers is installed
if [ ! -f "${SCRIPT_DIR}/.script-helpers/helpers.sh" ]; then
    echo "⚠️  Warning: script-helpers not found"
    echo "This script requires the script-helpers library."
    echo ""
    echo "To install it, run:"
    echo "  ./update"
    echo ""
    read -p "Would you like to run ./update now? (y/n): " response
    if [[ "$response" =~ ^[Yy]$ ]]; then
        "${SCRIPT_DIR}/update"
        echo ""
        echo "Please run ./start again"
        exit 0
    else
        echo "Exiting. Please run ./update before using this script."
        exit 1
    fi
fi

source "${SCRIPT_DIR}/.script-helpers/helpers.sh"
shlib_import logging help env

# Parse command line arguments
REBUILD=false
SETUP_ADMIN=false

while getopts "bsh" opt; do
    case $opt in
        b)
            REBUILD=true
            ;;
        s)
            SETUP_ADMIN=true
            ;;
        h)
            display_help "$0"
            exit 0
            ;;
        \?)
            echo "Invalid option: -$OPTARG" >&2
            echo "Use -h for help"
            exit 1
            ;;
    esac
done

log_info "Starting Nomisma - Coin Analysis System"

# Check if Docker is installed
if ! command -v docker &> /dev/null; then
    log_error "Docker is not installed"
    log_info "Please install Docker from https://docs.docker.com/get-docker/"
    exit 1
fi

# Check if Docker Compose is installed
if ! command -v docker-compose &> /dev/null && ! docker compose version &> /dev/null; then
    log_error "Docker Compose is not installed"
    log_info "Please install Docker Compose from https://docs.docker.com/compose/install/"
    exit 1
fi

# Determine compose command
if command -v docker-compose &> /dev/null; then
    COMPOSE_CMD="docker-compose"
else
    COMPOSE_CMD="docker compose"
fi

# Check if .env file exists, create from example if not
if [ ! -f .env ]; then
    log_warn ".env file not found"
    if [ -f .env.example ]; then
        log_info "Creating .env from .env.example..."
        cp .env.example .env
        log_info "Created .env file"
    else
        log_error ".env.example not found!"
        exit 1
    fi
fi

# Load environment variables using script-helpers
load_env .env

# Check for required environment variables using script-helpers
MISSING_VARS=()

# Database credentials (required)
if ! require_env POSTGRES_USER 2>/dev/null || [ "$POSTGRES_USER" = "your_postgres_user" ]; then
    MISSING_VARS+=("POSTGRES_USER")
fi

if ! require_env POSTGRES_PASSWORD 2>/dev/null || [ "$POSTGRES_PASSWORD" = "your_postgres_password" ]; then
    MISSING_VARS+=("POSTGRES_PASSWORD")
fi

# Secret key (required for authentication)
if ! require_env SECRET_KEY 2>/dev/null || [ "$SECRET_KEY" = "your-secret-key-change-in-production-use-openssl-rand-hex-32" ]; then
    MISSING_VARS+=("SECRET_KEY")
fi

# Optional but recommended
OPTIONAL_MISSING=()
if [ -z "$GEMINI_API_KEY" ] || [ "$GEMINI_API_KEY" = "your_gemini_api_key_here" ]; then
    OPTIONAL_MISSING+=("GEMINI_API_KEY (AI features will use mock data)")
fi

if [ -z "$EBAY_APP_ID" ] || [ "$EBAY_APP_ID" = "your_ebay_app_id" ]; then
    OPTIONAL_MISSING+=("EBAY_APP_ID (eBay features will use mock data)")
fi

# If there are missing required variables, prompt for them
if [ ${#MISSING_VARS[@]} -gt 0 ]; then
    echo ""
    log_error "Missing required environment variables!"
    echo ""
    
    for var in "${MISSING_VARS[@]}"; do
        echo "   - $var"
    done
    
    echo ""
    log_info "Please configure these variables:"
    echo ""
    
    # Prompt for each missing variable
    if [[ " ${MISSING_VARS[@]} " =~ " POSTGRES_USER " ]]; then
        read -p "Enter PostgreSQL username [nomisma_user]: " POSTGRES_USER
        POSTGRES_USER=${POSTGRES_USER:-nomisma_user}
        sed -i "s/^POSTGRES_USER=.*/POSTGRES_USER=$POSTGRES_USER/" .env
    fi
    
    if [[ " ${MISSING_VARS[@]} " =~ " POSTGRES_PASSWORD " ]]; then
        read -sp "Enter PostgreSQL password: " POSTGRES_PASSWORD
        echo ""
        sed -i "s/^POSTGRES_PASSWORD=.*/POSTGRES_PASSWORD=$POSTGRES_PASSWORD/" .env
    fi
    
    if [[ " ${MISSING_VARS[@]} " =~ " SECRET_KEY " ]]; then
        log_info "Generating secure SECRET_KEY..."
        SECRET_KEY=$(openssl rand -hex 32 2>/dev/null || cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 64 | head -n 1)
        sed -i "s|^SECRET_KEY=.*|SECRET_KEY=$SECRET_KEY|" .env
        log_info "Generated SECRET_KEY"
    fi
    
    echo ""
    log_info "Required variables configured!"
    
    # Reload environment after updates
    load_env .env
fi

# Show warnings for optional missing variables with helpful setup links
if [ ${#OPTIONAL_MISSING[@]} -gt 0 ]; then
    echo ""
    log_warn "Optional API keys not configured:"
    for var in "${OPTIONAL_MISSING[@]}"; do
        echo "   - $var"
    done
    echo ""
    
    # Offer to help set up API keys
    log_info "Would you like to set up these API keys now?"
    echo ""
    read -p "Configure API keys? (y/n): " setup_apis
    
    if [[ "$setup_apis" =~ ^[Yy]$ ]]; then
        
        # Gemini API Key Setup
        if [ -z "$GEMINI_API_KEY" ] || [ "$GEMINI_API_KEY" = "your_gemini_api_key_here" ]; then
            echo ""
            log_info "=== Google Gemini API Key Setup ==="
            echo ""
            echo "Steps to get your Gemini API key:"
            echo "1. Sign in with your Google account"
            echo "2. Click 'Get API key' button"
            echo "3. Create a new API key or use existing one"
            echo "4. Copy the API key"
            echo ""
            echo "URL: https://makersuite.google.com/app/apikey"
            echo ""
            read -p "Open browser to get Gemini API key? (y/n): " open_gemini
            
            if [[ "$open_gemini" =~ ^[Yy]$ ]]; then
                if command -v xdg-open &> /dev/null; then
                    xdg-open "https://makersuite.google.com/app/apikey" &> /dev/null &
                elif command -v open &> /dev/null; then
                    open "https://makersuite.google.com/app/apikey" &> /dev/null &
                fi
                log_info "Browser opened. Get your API key and return here."
            fi
            
            echo ""
            read -p "Enter your Gemini API key (or press Enter to skip): " GEMINI_KEY
            
            if [ -n "$GEMINI_KEY" ]; then
                sed -i "s|^GEMINI_API_KEY=.*|GEMINI_API_KEY=$GEMINI_KEY|" .env
                log_info "Gemini API key saved!"
            else
                log_warn "Skipped Gemini API key. AI features will use mock data."
            fi
        fi
        
        # eBay API Setup
        if [ -z "$EBAY_APP_ID" ] || [ "$EBAY_APP_ID" = "your_ebay_app_id" ]; then
            echo ""
            log_info "=== eBay API Credentials Setup ==="
            echo ""
            echo "Steps to get eBay API credentials:"
            echo "1. Sign in to eBay Developer Program"
            echo "2. Go to 'My Account' > 'Application Keys'"
            echo "3. Create a new application or use existing"
            echo "4. Get your App ID, Dev ID, and Cert ID"
            echo "5. Generate a User Token for authentication"
            echo ""
            echo "URL: https://developer.ebay.com/my/keys"
            echo ""
            echo "Note: You'll need to register for the eBay Developer Program first"
            echo "Registration: https://developer.ebay.com/join"
            echo ""
            read -p "Open browser to get eBay credentials? (y/n): " open_ebay
            
            if [[ "$open_ebay" =~ ^[Yy]$ ]]; then
                if command -v xdg-open &> /dev/null; then
                    xdg-open "https://developer.ebay.com/my/keys" &> /dev/null &
                elif command -v open &> /dev/null; then
                    open "https://developer.ebay.com/my/keys" &> /dev/null &
                fi
                log_info "Browser opened. Get your credentials and return here."
            fi
            
            echo ""
            log_info "Enter eBay credentials (or press Enter to skip each):"
            
            read -p "eBay App ID: " EBAY_APP
            if [ -n "$EBAY_APP" ]; then
                sed -i "s|^EBAY_APP_ID=.*|EBAY_APP_ID=$EBAY_APP|" .env
            fi
            
            read -p "eBay Dev ID: " EBAY_DEV
            if [ -n "$EBAY_DEV" ]; then
                sed -i "s|^EBAY_DEV_ID=.*|EBAY_DEV_ID=$EBAY_DEV|" .env
            fi
            
            read -p "eBay Cert ID: " EBAY_CERT
            if [ -n "$EBAY_CERT" ]; then
                sed -i "s|^EBAY_CERT_ID=.*|EBAY_CERT_ID=$EBAY_CERT|" .env
            fi
            
            read -p "eBay User Token: " EBAY_TOKEN
            if [ -n "$EBAY_TOKEN" ]; then
                sed -i "s|^EBAY_USER_TOKEN=.*|EBAY_USER_TOKEN=$EBAY_TOKEN|" .env
            fi
            
            if [ -n "$EBAY_APP" ] || [ -n "$EBAY_DEV" ] || [ -n "$EBAY_CERT" ] || [ -n "$EBAY_TOKEN" ]; then
                log_info "eBay credentials saved!"
            else
                log_warn "Skipped eBay credentials. eBay features will use mock data."
            fi
        fi
        
        echo ""
        log_info "API key configuration complete!"
        
        # Reload environment after updates
        load_env .env
        
    else
        log_info "Skipping API key setup. The application will start with limited functionality."
        log_info "You can configure API keys later by:"
        echo "  1. Editing .env file manually"
        echo "  2. Running './start' again and choosing to configure"
        echo ""
    fi
    
    read -p "Press Enter to continue starting the application..."
fi

# Create images directory if it doesn't exist
mkdir -p images

echo ""
log_info "Starting Docker containers..."
echo ""

# Build and start containers
if [ "$REBUILD" = true ]; then
    log_info "Rebuilding Docker images..."
    $COMPOSE_CMD up -d --build
else
    $COMPOSE_CMD up -d
fi

echo ""
log_info "Waiting for services to be ready..."
sleep 5

# Check if services are running
BACKEND_STATUS=$($COMPOSE_CMD ps -q backend | xargs docker inspect -f '{{.State.Status}}' 2>/dev/null || echo "not running")
FRONTEND_STATUS=$($COMPOSE_CMD ps -q frontend | xargs docker inspect -f '{{.State.Status}}' 2>/dev/null || echo "not running")
DB_STATUS=$($COMPOSE_CMD ps -q db | xargs docker inspect -f '{{.State.Status}}' 2>/dev/null || echo "not running")

echo ""
log_info "Service Status:"
echo "   Database:  $DB_STATUS"
echo "   Backend:   $BACKEND_STATUS"
echo "   Frontend:  $FRONTEND_STATUS"
echo ""

if [ "$BACKEND_STATUS" = "running" ] && [ "$FRONTEND_STATUS" = "running" ] && [ "$DB_STATUS" = "running" ]; then
    log_info "All services are running!"
    echo ""
    
    # Setup admin user if requested
    if [ "$SETUP_ADMIN" = true ]; then
        echo ""
        log_info "Admin User Setup"
        echo ""
        
        read -p "Enter admin username: " ADMIN_USERNAME
        read -sp "Enter admin password: " ADMIN_PASSWORD
        echo ""
        read -sp "Confirm admin password: " ADMIN_PASSWORD_CONFIRM
        echo ""
        
        if [ "$ADMIN_PASSWORD" != "$ADMIN_PASSWORD_CONFIRM" ]; then
            log_error "Passwords do not match!"
            exit 1
        fi
        
        read -p "Enter admin email: " ADMIN_EMAIL
        
        echo ""
        log_info "Creating admin user..."
        
        # Wait a bit more for backend to be fully ready
        sleep 3
        
        # Create admin user via API
        RESPONSE=$(curl -s -X POST http://localhost:8000/api/auth/register \
            -H "Content-Type: application/json" \
            -d "{\"username\":\"$ADMIN_USERNAME\",\"email\":\"$ADMIN_EMAIL\",\"password\":\"$ADMIN_PASSWORD\"}")
        
        if echo "$RESPONSE" | grep -q "id"; then
            log_info "Admin user created successfully!"
            echo "   Username: $ADMIN_USERNAME"
            echo "   Email: $ADMIN_EMAIL"
        else
            log_error "Failed to create admin user"
            echo "   Response: $RESPONSE"
            log_info "You can try again later with: ./start -s"
        fi
        echo ""
    fi
    
    log_info "Application URLs:"
    echo "   Frontend:  http://localhost:3000"
    echo "   Backend:   http://localhost:8000"
    echo "   API Docs:  http://localhost:8000/docs"
    echo ""
    log_info "Quick Tips:"
    echo "   - Run './status' to check service health"
    echo "   - Run '$COMPOSE_CMD logs -f' to view logs"
    echo "   - Run './stop' to stop all services"
    if [ "$SETUP_ADMIN" != true ]; then
        echo "   - Run './start -s' to create an admin user"
    fi
    echo ""
    
    # Try to open browser
    if command -v xdg-open &> /dev/null; then
        log_info "Opening application in browser..."
        xdg-open http://localhost:3000 &> /dev/null &
    elif command -v open &> /dev/null; then
        log_info "Opening application in browser..."
        open http://localhost:3000 &> /dev/null &
    fi
else
    log_warn "Some services may not be running properly"
    echo "   Run './status' for more details"
    echo "   Run '$COMPOSE_CMD logs' to view error messages"
fi

echo ""
log_info "Nomisma is ready!"
